# vim: set filetype=make syntax=sh ts=8 sw=8 sts=0 noexpandtab :
#
# Release repos for nrgaway
#
# Contains all release specific tools, etc for signing and releasing packages.

# ====
# Docs
# ====
# 
#     doc/ReleaseManagerWorkflow.md
#     doc/SplitGPG.md
#     doc/TemplateDispVMBuild.md

# ====
# TODO
# ====
# - Create a BUILDER_PLUGIN to install nrgaway repo when building templates
# - Create a nrgaway branch of 'linux-yum' and 'linux-deb'
# - Create separate keys for Fedora and Debian
# - Work on better web permissions, ssh certificate to update haswell
#
# - Implement split-gpg
# - Implement DisposibleVM building -- Maybe create dom0 salt formula
# - Implement proxy to speed up build times
# - Consider using a shared 'src' directory
#   
# - How to use repo-latest-snapshot

[==- 'NOTES' ===================================================================
# -------------
# Initial Steps
# -------------
# XXX:  Need  to update keys.conf to import separate keys for Fedora and Debian.
#       Should there are be separate keys for each version as well?
#
# - First need to import key into rpm so rpm's can be verified.  keys.conf should
#   take care of this step:
#       sudo rpm --import nrgaway-qubes-signing-key.asc
#
# - Make sure release.conf is included in builder.conf and configured to liking.
#
# - Copy ssh public key to remote-host using ssh-copy-id
#        ssh-copy-id -i ~/.ssh/id_rsa.pub remote-host
#
# - On web server, install createrepo
#       apt-get install createrepo
#
# --------------
# Build Packages
# --------------
# Increment version number, if needed
#     See doc/ReleaseManagerWorkflow.md
#
# Build all packages as normal
#     make qubes-vm
#
# ---------------------------------
# Signing and Updating Fedora Repos
# ---------------------------------
#
# Check release status
#     make check-release-status
#
# Uploading Fedora packages to current-testing
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#     make sign-vm update-repo-current-testing
#
# Uploading Fedora packages to current
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#     make sign-vm update-repo-current
#
# -----------------------------
# Syncing to Active Remote Repo
# -----------------------------
# To test, run in 'dry' mode
#     cd qubes-src/linux-yum
#     DRY=-n ./sync_qubes-os.org_repo.sh r3.1
#
# To proceed with actual update to remote repo
#     cd qubes-src/linux-yum
#     ./sync_qubes-os.org_repo.sh r3.1


[==- 'Release Management' ======================================================
[==- All qubes-builder overrides
[===============================================================================

   # Ensure the value is empty - packages will be signed
    NO_SIGN :=

    # Set proper signing key, choose the right ID depending on Qubes release
    # for which you build packages here
    #
    # TODO: Create separate signing keys for rpm and deb
    SIGN_KEY = 5A4C6DAD
    DEBIAN_SIGN_KEY = 5A4C6DAD

    # Sanity check - verify if you are on the right branch before building the
    # component. Note that this does not fully work for vmm-xen, because of
    # additional components used during the build.
    CHECK_BRANCH = 1

    # Target repositories (depending on target release)
    #
    # TODO:  Automatically create these BASEDIR based on TARGET_RELEASE_VERSION
    #        and DIST and fedora vs debian vs archlinux?
    TARGET_RELEASE_VERSION = r3.1
    LINUX_REPO_fc20_BASEDIR = $(SRC_DIR)/linux-yum/$(TARGET_RELEASE_VERSION)
    LINUX_REPO_fc21_BASEDIR = $(SRC_DIR)/linux-yum/$(TARGET_RELEASE_VERSION)
    LINUX_REPO_fc22_BASEDIR = $(SRC_DIR)/linux-yum/$(TARGET_RELEASE_VERSION)
    LINUX_REPO_fc23_BASEDIR = $(SRC_DIR)/linux-yum/$(TARGET_RELEASE_VERSION)
    LINUX_REPO_fc24_BASEDIR = $(SRC_DIR)/linux-yum/$(TARGET_RELEASE_VERSION)
    LINUX_REPO_wheezy_BASEDIR = $(SRC_DIR)/linux-deb/$(TARGET_RELEASE_VERSION)
    LINUX_REPO_jessie_BASEDIR = $(SRC_DIR)/linux-deb/$(TARGET_RELEASE_VERSION)
    LINUX_REPO_stretch_BASEDIR = $(SRC_DIR)/linux-deb/$(TARGET_RELEASE_VERSION)
    LINUX_REPO_trusty_BASEDIR = $(SRC_DIR)/linux-deb/$(TARGET_RELEASE_VERSION)
    LINUX_REPO_utopic_BASEDIR = $(SRC_DIR)/linux-deb/$(TARGET_RELEASE_VERSION)
    LINUX_REPO_vivid_BASEDIR = $(SRC_DIR)/linux-deb/$(TARGET_RELEASE_VERSION)
    LINUX_REPO_wily_BASEDIR = $(SRC_DIR)/linux-deb/$(TARGET_RELEASE_VERSION)

    # Automatically upload the packages when update-repo-* targets are called
    #AUTOMATIC_UPLOAD = 1
    AUTOMATIC_UPLOAD = 0

    # Template labels
    TEMPLATE_LABEL := 
    TEMPLATE_LABEL += fc20:fedora-20
    TEMPLATE_LABEL += fc21:fedora-21
    TEMPLATE_LABEL += fc22:fedora-22
    TEMPLATE_LABEL += fc23:fedora-23
    TEMPLATE_LABEL += fc24:fedora-24
    TEMPLATE_LABEL += wheezy:debian-7
    TEMPLATE_LABEL += jessie:debian-8
    TEMPLATE_LABEL += stretch:debian-9
    TEMPLATE_LABEL += trusty:trusty
    TEMPLATE_LABEL += utopic:utopic
    TEMPLATE_LABEL += vivid:vivid
    TEMPLATE_LABEL += wily:wily


[==- 'installer-qubes-os' ======================================================
[==- Qubes installer tools
[===============================================================================
COMPONENTS += installer-qubes-os
TEMPLATE += installer-qubes-os
GIT_URL_qubes_installer_qubes_os = $(GITHUB_PREFIX)installer-qubes-os.git
BRANCH_qubes_installer_qubes_os = $(word $(RELEASE_INDEX), master master master)
REPO_TRACK += installer-qubes-os:master:marmarek:master


[==- 'linux-deb' ===============================================================
[==- Release management Qubes component scripts for Debian
[==- 'deb.qubes-os.org repository'
[===============================================================================
COMPONENTS += linux-deb
TEMPLATE += linux-deb
GIT_URL_qubes_linux_deb = $(GITHUB_PREFIX)linux-deb.git
BRANCH_qubes_linux_deb = $(word $(RELEASE_INDEX), master master master)
REPO_TRACK += linux-deb:master:marmarek:master


[==- 'linux-yum' ===============================================================
[==- Release management Qubes component scripts for Fedora
[===============================================================================
COMPONENTS += linux-yum
TEMPLATE += linux-yum
GIT_URL_qubes_linux_yum = $(GITHUB_PREFIX)linux-yum.git
BRANCH_qubes_linux_yum = nrgaway
REPO_TRACK += linux-yum:nrgaway:marmarek:master


# Release dependencies
DEPENDENCIES += createrepo


about::
	@echo "release.conf"
